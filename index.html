<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’è¡¨ - äº‘åŒæ­¥ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .device-info {
            background: linear-gradient(135deg, #fff3e0, #ffecb3);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-name {
            font-weight: 600;
            color: #e65100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #666;
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #9e9e9e;
        }

        .sync-indicator.success {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .sync-indicator.syncing {
            background: #ff9800;
            animation: pulse 1s infinite;
        }

        .sync-indicator.error {
            background: #f44336;
        }

        .sync-indicator.offline {
            background: #9e9e9e;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .last-save {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .title-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .input-wrapper.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }

        input, select {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .category-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .category-input-group input {
            flex: 1;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #9e9e9e;
        }

        .btn-secondary:hover {
            background: #757575;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-save {
            background: #4caf50;
        }

        .btn-save:hover {
            background: #45a049;
        }

        .btn-sync {
            background: #2196f3;
        }

        .btn-sync:hover {
            background: #1976d2;
        }

        .btn-export {
            background: #ff9800;
        }

        .btn-export:hover {
            background: #f57c00;
        }

        .btn-import {
            background: #9c27b0;
        }

        .btn-import:hover {
            background: #7b1fa2;
        }

        .btn-clear {
            background: #f44336;
        }

        .btn-clear:hover {
            background: #d32f2f;
        }

        .btn-settings {
            background: #607d8b;
        }

        .btn-settings:hover {
            background: #455a64;
        }

        .categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .category-tag {
            background: #e0e7ff;
            color: #4338ca;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .category-tag .remove {
            cursor: pointer;
            font-weight: bold;
            color: #4338ca;
        }

        .category-tag .remove:hover {
            color: #312e81;
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .category-filter {
            margin-bottom: 10px;
        }

        .filter-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
        }

        .filter-item:hover {
            background: #f5f5f5;
        }

        .filter-item.active {
            background: #667eea;
            color: white;
        }

        .filter-item .today-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            margin-left: 6px;
            animation: pulse 2s infinite;
        }

        .filter-count {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .filter-item.active .filter-count {
            background: rgba(255, 255, 255, 0.3);
        }

        .tasks-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 18px;
        }

        .task-card {
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .task-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .task-header {
            padding: 20px;
            cursor: pointer;
            position: relative;
        }

        .task-header.no-schedule {
            background: #fff3e0;
        }

        .task-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .task-title-area {
            flex: 1;
        }

        .task-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .task-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .task-categories {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .task-category-badge {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .today-badge {
            background: #ffeb3b;
            color: #f57f17;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .no-schedule-badge {
            background: #ff9800;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .task-time {
            font-size: 14px;
            color: #666;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            transform: scale(1.2);
        }

        .task-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .task-content.expanded {
            max-height: 2000px;
        }

        .task-edit-section {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .task-edit-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #555;
        }

        .edit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .schedule-grid {
            padding: 20px;
            display: grid;
            gap: 12px;
        }

        .review-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .review-item:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }

        .review-item.completed {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .review-item.overdue {
            background: #ffebee;
            border-color: #f44336;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-done {
            background: #4caf50;
            color: white;
        }

        .badge-overdue {
            background: #f44336;
            color: white;
        }

        .badge-current {
            background: #2196f3;
            color: white;
        }

        .review-time {
            color: #666;
            font-size: 14px;
            flex: 1;
            text-align: center;
        }

        .check-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .check-btn.unchecked {
            background: #e0e0e0;
            color: #666;
        }

        .check-btn.unchecked:hover {
            background: #4caf50;
            color: white;
        }

        .check-btn.checked {
            background: #4caf50;
            color: white;
        }

        #importFile {
            display: none;
        }

        .info-box {
            padding: 12px 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 13px;
            border-left: 4px solid;
        }

        .info-box.cloud {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }

        .info-box.offline {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }

        .info-box.success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .btn-delete {
            background: #f44336;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .sync-guide {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 13px;
        }

        .sync-guide h4 {
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .sync-guide ul {
            margin-left: 20px;
            color: #555;
        }

        .sync-guide li {
            margin-bottom: 5px;
        }

        /* Modal æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .form-help a {
            color: #2196f3;
            text-decoration: none;
        }

        .form-help a:hover {
            text-decoration: underline;
        }

        .toggle-section {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
        }

        .toggle-label input[type="checkbox"] {
            width: auto;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .edit-row {
                grid-template-columns: 1fr;
            }

            .title-actions {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è®¾å¤‡ä¿¡æ¯æ  -->
        <div class="device-info">
            <div>
                <div class="device-name">
                    <span id="deviceIcon">ğŸ’»</span>
                    <span id="deviceName">å½“å‰è®¾å¤‡</span>
                </div>
                <div class="last-save" id="lastSave">æ­£åœ¨åˆå§‹åŒ–...</div>
            </div>
            <div class="sync-status">
                <span class="sync-indicator" id="syncIndicator"></span>
                <span id="syncStatus">ç¦»çº¿æ¨¡å¼</span>
            </div>
        </div>

        <div class="header">
            <div class="title">
                <div class="title-left">
                    <span>ğŸ“š è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿å¤ä¹ è®¡åˆ’è¡¨</span>
                </div>
                <div class="title-actions">
                    <button class="btn btn-small btn-sync" onclick="manualSync()" id="manualSyncBtn">
                        â˜ï¸ ç«‹å³åŒæ­¥
                    </button>
                    <button class="btn btn-small btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡ºå¤‡ä»½</button>
                    <label for="importFile" class="btn btn-small btn-import" style="margin: 0;">
                        ğŸ“¤ å¯¼å…¥å¤‡ä»½
                    </label>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                    <button class="btn btn-small btn-settings" onclick="openSettings()">âš™ï¸ äº‘åŒæ­¥è®¾ç½®</button>
                    <button class="btn btn-small btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
                </div>
            </div>

            <div class="input-row">
                <div class="input-wrapper">
                    <label for="taskName">å­¦ä¹ ä»»åŠ¡åç§° *</label>
                    <input type="text" id="taskName" placeholder="ä¾‹å¦‚ï¼šèƒŒå•è¯List1">
                </div>
                <div class="input-wrapper">
                    <label for="startDate">å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼Œåç»­ä¹Ÿå¯è®¾ç½®ï¼‰</label>
                    <input type="date" id="startDate">
                </div>
            </div>

            <div class="input-row">
                <div class="input-wrapper">
                    <label>æ·»åŠ æ–°åˆ†ç±»</label>
                    <div class="category-input-group">
                        <input type="text" id="newCategory" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°">
                        <button class="btn btn-small" onclick="addCategory()">æ·»åŠ </button>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label for="categorySelect">é€‰æ‹©åˆ†ç±»ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <select id="categorySelect">
                        <option value="">-- é€‰æ‹©åˆ†ç±» --</option>
                    </select>
                </div>
            </div>

            <div class="input-wrapper full-width">
                <label>å·²é€‰æ‹©çš„åˆ†ç±»</label>
                <div class="categories-list" id="selectedCategories"></div>
            </div>

            <button class="btn" onclick="addTask()">â• æ·»åŠ å­¦ä¹ ä»»åŠ¡</button>

            <div class="info-box" id="statusInfo">
                ğŸ’¡ æ­£åœ¨æ£€æµ‹å­˜å‚¨æ¨¡å¼...
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-title">åˆ†ç±»ç­›é€‰</div>
                <div class="category-filter" id="categoryFilter"></div>
            </div>
            <div class="tasks-content">
                <div id="tasksContainer"></div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½® Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ äº‘åŒæ­¥è®¾ç½®</div>
            <div class="modal-body">
                <div class="toggle-section">
                    <label class="toggle-label">
                        <input type="checkbox" id="enableCloudSync" onchange="toggleCloudSync()">
                        <span>å¯ç”¨äº‘åŒæ­¥åŠŸèƒ½</span>
                    </label>
                    <div class="form-help" style="margin-top: 8px;">
                        å…³é—­åå°†ä½¿ç”¨æœ¬åœ°æµè§ˆå™¨å­˜å‚¨ï¼Œé€‚åˆå•è®¾å¤‡ä½¿ç”¨
                    </div>
                </div>

                <div id="cloudSettings" style="display: none;">
                    <div class="form-group">
                        <label>GitHub ç”¨æˆ·å *</label>
                        <input type="text" id="githubUser" placeholder="ä¾‹å¦‚ï¼špinocchio77">
                        <div class="form-help">ä½ çš„ GitHub ç”¨æˆ·å</div>
                    </div>
                    <div class="form-group">
                        <label>ä»“åº“åç§° *</label>
                        <input type="text" id="githubRepo" placeholder="ä¾‹å¦‚ï¼šmy-planner-">
                        <div class="form-help">ç”¨äºå­˜å‚¨æ•°æ®çš„ä»“åº“åï¼ˆå»ºè®®åˆ›å»ºç§æœ‰ä»“åº“ï¼‰</div>
                    </div>
                    <div class="form-group">
                        <label>GitHub Token *</label>
                        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                        <div class="form-help">
                            éœ€è¦ repo æƒé™ã€‚
                            <a href="https://github.com/settings/tokens/new?scopes=repo&description=Ebbinghaus%20Planner" target="_blank">åˆ›å»º Token â†’</a>
                        </div>
                    </div>
                    <div style="background: #fff3e0; padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 15px;">
                        âš ï¸ <strong>é¦–æ¬¡ä½¿ç”¨æç¤ºï¼š</strong><br>
                        1. è¯·ç¡®ä¿å·²åœ¨ GitHub åˆ›å»ºå¥½ä»“åº“<br>
                        2. Token éœ€è¦æœ‰ repo æƒé™<br>
                        3. Token ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ 
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-small" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn btn-small" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // ===== å…¨å±€å˜é‡ =====
        let tasks = [];
        let categories = ['è‹±è¯­', 'æ•°å­¦', 'ç¼–ç¨‹', 'é˜…è¯»'];
        let selectedTaskCategories = [];
        let currentFilter = '';
        let isSyncing = false;
        let cloudSyncEnabled = localStorage.getItem('cloud_sync_enabled') === 'true';

        // GitHub é…ç½®
        let GITHUB_CONFIG = {
            user: localStorage.getItem('github_user') || '',
            repo: localStorage.getItem('github_repo') || '',
            token: localStorage.getItem('github_token') || '',
            filePath: 'data.json'
        };

        // ===== åˆå§‹åŒ– =====
        window.addEventListener('DOMContentLoaded', async function() {
            detectDevice();
            
            if (cloudSyncEnabled && isConfigured()) {
                await initializeCloudMode();
            } else {
                initializeLocalMode();
            }
        });

        // äº‘ç«¯æ¨¡å¼åˆå§‹åŒ–
        async function initializeCloudMode() {
            updateSyncStatus('syncing', 'æ­£åœ¨ä»äº‘ç«¯åŠ è½½...');
            updateInfoBox('cloud', 'â˜ï¸ äº‘åŒæ­¥æ¨¡å¼å·²å¯ç”¨ï¼Œæ­£åœ¨è¿æ¥...');
            
            try {
                await loadDataFromGitHub();
                updateSyncStatus('success', 'äº‘ç«¯åŒæ­¥æˆåŠŸ');
                updateInfoBox('success', 'âœ… äº‘åŒæ­¥å·²è¿æ¥ï¼Œæ•°æ®è‡ªåŠ¨ä¿å­˜åˆ° GitHub');
            } catch (error) {
                console.error('äº‘ç«¯åŠ è½½å¤±è´¥:', error);
                updateSyncStatus('error', 'äº‘ç«¯è¿æ¥å¤±è´¥');
                
                // å°è¯•ä»æœ¬åœ°æ¢å¤
                if (loadDataFromLocal()) {
                    updateInfoBox('offline', 
                        `âš ï¸ äº‘ç«¯è¿æ¥å¤±è´¥ï¼š${error.message}<br><br>` +
                        'å·²åŠ è½½æœ¬åœ°ç¼“å­˜æ•°æ®ã€‚ä½ å¯ä»¥ï¼š<br>' +
                        '1. æ£€æŸ¥ç½‘ç»œè¿æ¥åç‚¹å‡»"ç«‹å³åŒæ­¥"<br>' +
                        '2. ç‚¹å‡»"äº‘åŒæ­¥è®¾ç½®"æ£€æŸ¥é…ç½®<br>' +
                        '3. æˆ–ç»§ç»­ä½¿ç”¨ç¦»çº¿æ¨¡å¼ï¼ˆæ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼‰'
                    );
                } else {
                    updateInfoBox('offline', 
                        `âŒ äº‘ç«¯è¿æ¥å¤±è´¥ï¼š${error.message}<br><br>` +
                        'è¯·ç‚¹å‡»"äº‘åŒæ­¥è®¾ç½®"æ£€æŸ¥é…ç½®ï¼Œæˆ–å…³é—­äº‘åŒæ­¥ä½¿ç”¨æœ¬åœ°æ¨¡å¼'
                    );
                }
            } finally {
                renderAll();
            }
        }

        // æœ¬åœ°æ¨¡å¼åˆå§‹åŒ–
        function initializeLocalMode() {
            updateSyncStatus('offline', 'æœ¬åœ°å­˜å‚¨æ¨¡å¼');
            loadDataFromLocal();
            renderAll();
            updateInfoBox('offline', 
                'ğŸ“ å½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Œæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ä¸­<br><br>' +
                'å¦‚éœ€å¤šè®¾å¤‡åŒæ­¥ï¼Œè¯·ç‚¹å‡»"äº‘åŒæ­¥è®¾ç½®"å¯ç”¨äº‘åŒæ­¥åŠŸèƒ½'
            );
        }

        function renderAll() {
            renderCategorySelect();
            renderSelectedCategories();
            renderCategoryFilter();
            renderTasks();
        }

        // æ£€æµ‹è®¾å¤‡ç±»å‹
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            let deviceIcon = 'ğŸ’»';
            let deviceName = 'ç”µè„‘ç«¯';
            
            if (/iphone|ipad|ipod/.test(userAgent)) {
                deviceIcon = 'ğŸ“±';
                deviceName = 'iOSè®¾å¤‡';
            } else if (/android/.test(userAgent)) {
                deviceIcon = 'ğŸ“±';
                deviceName = 'Androidè®¾å¤‡';
            } else if (/windows/.test(userAgent)) {
                deviceIcon = 'ğŸ’»';
                deviceName = 'Windowsç”µè„‘';
            } else if (/macintosh|mac os/.test(userAgent)) {
                deviceIcon = 'ğŸ–¥ï¸';
                deviceName = 'Macç”µè„‘';
            }
            
            document.getElementById('deviceIcon').textContent = deviceIcon;
            document.getElementById('deviceName').textContent = deviceName;
        }

        // ===== å­˜å‚¨æ¨¡å¼åˆ‡æ¢ =====
        
        function toggleCloudSync() {
            const enabled = document.getElementById('enableCloudSync').checked;
            document.getElementById('cloudSettings').style.display = enabled ? 'block' : 'none';
        }

        // ===== GitHub äº‘åŒæ­¥åŠŸèƒ½ =====
        
        function isConfigured() {
            return GITHUB_CONFIG.user && GITHUB_CONFIG.repo && GITHUB_CONFIG.token;
        }

        async function loadDataFromGitHub() {
            if (!isConfigured()) {
                throw new Error('GitHub é…ç½®æœªå®Œæˆ');
            }

            const url = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.filePath}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (response.status === 404) {
                console.log('data.json ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                document.getElementById('lastSave').textContent = 'é¦–æ¬¡ä½¿ç”¨';
                return;
            }

            if (!response.ok) {
                const errorData = await response.json();
                if (response.status === 401) {
                    throw new Error('Token æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                } else if (response.status === 403) {
                    throw new Error('Token æƒé™ä¸è¶³ï¼Œéœ€è¦ repo æƒé™');
                } else {
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
            }

            const data = await response.json();
            const content = decodeBase64Unicode(data.content);
            const parsedData = JSON.parse(content);

            tasks = parsedData.tasks || [];
            categories = parsedData.categories || ['è‹±è¯­', 'æ•°å­¦', 'ç¼–ç¨‹', 'é˜…è¯»'];
            currentFilter = parsedData.currentFilter || '';

            // ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºç¼“å­˜
            saveDataToLocal();

            const saveTime = new Date(parsedData.savedAt || Date.now());
            document.getElementById('lastSave').textContent = 
                `ä¸Šæ¬¡åŒæ­¥: ${formatDateTime(saveTime, false)} ${saveTime.getHours()}:${String(saveTime.getMinutes()).padStart(2, '0')}`;
            
            console.log(`âœ… æˆåŠŸä»äº‘ç«¯åŠ è½½ ${tasks.length} ä¸ªä»»åŠ¡`);
        }

        async function saveDataToGitHub() {
            if (!cloudSyncEnabled || !isConfigured()) {
                console.log('äº‘åŒæ­¥æœªå¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                saveDataToLocal();
                return;
            }

            if (isSyncing) {
                console.log('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡ä¿å­˜');
                return;
            }

            isSyncing = true;
            updateSyncStatus('syncing', 'æ­£åœ¨åŒæ­¥...');

            try {
                const data = {
                    tasks: tasks,
                    categories: categories,
                    currentFilter: currentFilter,
                    savedAt: new Date().toISOString(),
                    version: '3.0-cloud',
                    device: detectDeviceType()
                };

                const url = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.filePath}`;
                
                // å…ˆè·å–æ–‡ä»¶çš„ SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let sha = null;
                try {
                    const getResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    console.log('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                }

                // ä¿å­˜æ–‡ä»¶
                const content = encodeBase64Unicode(JSON.stringify(data, null, 2));
                const putResponse = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update from ${detectDeviceType()} - ${new Date().toLocaleString('zh-CN')}`,
                        content: content,
                        sha: sha
                    })
                });

                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(errorData.message || 'ä¿å­˜å¤±è´¥');
                }

                // ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºç¼“å­˜
                saveDataToLocal();

                updateSyncStatus('success', 'äº‘ç«¯åŒæ­¥æˆåŠŸ');
                const saveTime = new Date();
                document.getElementById('lastSave').textContent = 
                    `ä¸Šæ¬¡åŒæ­¥: ${formatDateTime(saveTime, false)} ${saveTime.getHours()}:${String(saveTime.getMinutes()).padStart(2, '0')}`;
                
                console.log('âœ… æ•°æ®å·²åŒæ­¥åˆ° GitHub');
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                updateSyncStatus('error', 'åŒæ­¥å¤±è´¥');
                
                // å¤±è´¥æ—¶ä¿å­˜åˆ°æœ¬åœ°
                saveDataToLocal();
                
                // ä¸å¼¹çª—ï¼Œåªåœ¨çŠ¶æ€æ æ˜¾ç¤º
                updateInfoBox('offline', 
                    `âš ï¸ äº‘ç«¯åŒæ­¥å¤±è´¥ï¼š${error.message}<br><br>` +
                    'æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚ç¨åä¼šè‡ªåŠ¨é‡è¯•ï¼Œæˆ–ç‚¹å‡»"ç«‹å³åŒæ­¥"æ‰‹åŠ¨åŒæ­¥'
                );
            } finally {
                isSyncing = false;
            }
        }

        function detectDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            if (/iphone|ipad|ipod/.test(ua)) return 'iOS';
            if (/android/.test(ua)) return 'Android';
            if (/macintosh|mac os/.test(ua)) return 'Mac';
            if (/windows/.test(ua)) return 'Windows';
            return 'Web';
        }

        async function manualSync() {
            if (!cloudSyncEnabled) {
                alert('ğŸ’¡ äº‘åŒæ­¥æœªå¯ç”¨\n\nè¯·å…ˆç‚¹å‡»"äº‘åŒæ­¥è®¾ç½®"å¯ç”¨äº‘åŒæ­¥åŠŸèƒ½');
                return;
            }

            if (!isConfigured()) {
                alert('âš ï¸ äº‘åŒæ­¥æœªé…ç½®\n\nè¯·å…ˆç‚¹å‡»"äº‘åŒæ­¥è®¾ç½®"å®Œæˆé…ç½®');
                openSettings();
                return;
            }

            const btn = document.getElementById('manualSyncBtn');
            btn.disabled = true;
            btn.textContent = 'â³ åŒæ­¥ä¸­...';
            
            try {
                // å…ˆä¿å­˜åˆ°äº‘ç«¯
                isSyncing = false; // é‡ç½®æ ‡å¿—ä»¥å…è®¸åŒæ­¥
                await saveDataToGitHub();
                
                // å†ä»äº‘ç«¯åŠ è½½
                await loadDataFromGitHub();
                renderAll();
                
                updateInfoBox('success', 'âœ… äº‘ç«¯åŒæ­¥æˆåŠŸï¼æ‰€æœ‰è®¾å¤‡æ•°æ®å·²æ›´æ–°');
            } catch (error) {
                updateInfoBox('offline', `âŒ åŒæ­¥å¤±è´¥ï¼š${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'â˜ï¸ ç«‹å³åŒæ­¥';
            }
        }

        function updateSyncStatus(status, message) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            indicator.className = 'sync-indicator ' + status;
            statusText.textContent = message;
        }

        function updateInfoBox(type, message) {
            const infoBox = document.getElementById('statusInfo');
            infoBox.className = 'info-box ' + type;
            infoBox.innerHTML = message;
        }

        // ===== æœ¬åœ°å­˜å‚¨åŠŸèƒ½ =====
        
        function saveDataToLocal() {
            const data = {
                tasks: tasks,
                categories: categories,
                currentFilter: currentFilter,
                savedAt: new Date().toISOString(),
                version: '3.0-hybrid'
            };
            
            try {
                localStorage.setItem('ebbinghausData', JSON.stringify(data));
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
                
                if (!cloudSyncEnabled) {
                    const saveTime = new Date();
                    document.getElementById('lastSave').textContent = 
                        `æœ¬åœ°ä¿å­˜: ${formatDateTime(saveTime, false)} ${saveTime.getHours()}:${String(saveTime.getMinutes()).padStart(2, '0')}`;
                }
            } catch (e) {
                console.error('æœ¬åœ°ä¿å­˜å¤±è´¥:', e);
            }
        }

        function loadDataFromLocal() {
            try {
                const savedData = localStorage.getItem('ebbinghausData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    tasks = data.tasks || [];
                    categories = data.categories || ['è‹±è¯­', 'æ•°å­¦', 'ç¼–ç¨‹', 'é˜…è¯»'];
                    currentFilter = data.currentFilter || '';
                    
                    const saveTime = new Date(data.savedAt);
                    document.getElementById('lastSave').textContent = 
                        `æœ¬åœ°æ•°æ®: ${formatDateTime(saveTime, false)} ${saveTime.getHours()}:${String(saveTime.getMinutes()).padStart(2, '0')}`;
                    
                    console.log(`æˆåŠŸä»æœ¬åœ°åŠ è½½ ${tasks.length} ä¸ªä»»åŠ¡`);
                    return true;
                }
            } catch (e) {
                console.error('ä»æœ¬åœ°åŠ è½½å¤±è´¥:', e);
            }
            return false;
        }

        // Base64 ç¼–ç /è§£ç ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
        function encodeBase64Unicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }

        function decodeBase64Unicode(str) {
            return decodeURIComponent(atob(str).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        // ===== è®¾ç½®åŠŸèƒ½ =====
        
        function openSettings() {
            document.getElementById('enableCloudSync').checked = cloudSyncEnabled;
            document.getElementById('cloudSettings').style.display = cloudSyncEnabled ? 'block' : 'none';
            document.getElementById('githubUser').value = GITHUB_CONFIG.user;
            document.getElementById('githubRepo').value = GITHUB_CONFIG.repo;
            document.getElementById('githubToken').value = GITHUB_CONFIG.token;
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function saveSettings() {
            const enableSync = document.getElementById('enableCloudSync').checked;
            
            if (enableSync) {
                const user = document.getElementById('githubUser').value.trim();
                const repo = document.getElementById('githubRepo').value.trim();
                const token = document.getElementById('githubToken').value.trim();

                if (!user || !repo || !token) {
                    alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                    return;
                }

                GITHUB_CONFIG.user = user;
                GITHUB_CONFIG.repo = repo;
                GITHUB_CONFIG.token = token;

                localStorage.setItem('github_user', user);
                localStorage.setItem('github_repo', repo);
                localStorage.setItem('github_token', token);
            }

            cloudSyncEnabled = enableSync;
            localStorage.setItem('cloud_sync_enabled', enableSync);

            closeSettings();
            
            if (enableSync && isConfigured()) {
                alert('âœ… è®¾ç½®å·²ä¿å­˜ï¼\n\næ­£åœ¨è¿æ¥äº‘ç«¯...');
                await initializeCloudMode();
            } else {
                alert('âœ… è®¾ç½®å·²ä¿å­˜ï¼');
                initializeLocalMode();
            }
        }

        // ===== åˆ†ç±»ç®¡ç† =====
        
        function addCategory() {
            const input = document.getElementById('newCategory');
            const category = input.value.trim();
            
            if (!category) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                return;
            }
            
            if (categories.includes(category)) {
                alert('è¯¥åˆ†ç±»å·²å­˜åœ¨');
                return;
            }
            
            categories.push(category);
            input.value = '';
            renderCategorySelect();
            renderCategoryFilter();
            
            if (cloudSyncEnabled) {
                saveDataToGitHub();
            } else {
                saveDataToLocal();
            }
        }

        function removeCategory(category) {
            if (!confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»"${category}"å—ï¼Ÿ\n\næ³¨æ„ï¼šè¯¥åˆ†ç±»ä¼šä»æ‰€æœ‰ä»»åŠ¡ä¸­ç§»é™¤ã€‚`)) {
                return;
            }

            categories = categories.filter(c => c !== category);
            selectedTaskCategories = selectedTaskCategories.filter(c => c !== category);
            
            tasks.forEach(task => {
                task.categories = task.categories.filter(c => c !== category);
            });
            
            if (currentFilter === category) {
                currentFilter = '';
            }
            
            renderCategorySelect();
            renderSelectedCategories();
            renderCategoryFilter();
            renderTasks();
            
            if (cloudSyncEnabled) {
                saveDataToGitHub();
            } else {
                saveDataToLocal();
            }
        }

        function selectCategory() {
            const select = document.getElementById('categorySelect');
            const category = select.value;
            
            if (category && !selectedTaskCategories.includes(category)) {
                selectedTaskCategories.push(category);
                renderSelectedCategories();
            }
            
            select.value = '';
        }

        function removeSelectedCategory(category) {
            selectedTaskCategories = selectedTaskCategories.filter(c => c !== category);
            renderSelectedCategories();
        }

        function renderCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">-- é€‰æ‹©åˆ†ç±» --</option>';
            categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function renderSelectedCategories() {
            const container = document.getElementById('selectedCategories');
            if (selectedTaskCategories.length === 0) {
                container.innerHTML = '<span style="color: #999;">æœªé€‰æ‹©åˆ†ç±»</span>';
            } else {
                container.innerHTML = selectedTaskCategories.map(cat => `
                    <div class="category-tag">
                        <span>${cat}</span>
                        <span class="remove" onclick="removeSelectedCategory('${cat}')">Ã—</span>
                    </div>
                `).join('');
            }
        }

        function renderCategoryFilter() {
            const container = document.getElementById('categoryFilter');
            const taskCountByCategory = {};
            const todayTasksByCategory = {};
            
            categories.forEach(cat => {
                const categoryTasks = tasks.filter(task => task.categories.includes(cat));
                taskCountByCategory[cat] = categoryTasks.length;
                todayTasksByCategory[cat] = categoryTasks.some(task => hasTodayReview(task));
            });
            
            const hasAnyTodayReview = tasks.some(task => hasTodayReview(task));
            
            container.innerHTML = `
                <div class="filter-item ${currentFilter === '' ? 'active' : ''}" 
                     onclick="setFilter('')">
                    <span style="display: flex; align-items: center;">
                        å…¨éƒ¨ä»»åŠ¡
                        ${hasAnyTodayReview ? '<span class="today-indicator"></span>' : ''}
                    </span>
                    <span class="filter-count">${tasks.length}</span>
                </div>
                ${categories.map(cat => `
                    <div class="filter-item ${currentFilter === cat ? 'active' : ''}" 
                         onclick="setFilter('${cat}')">
                        <span style="display: flex; align-items: center;">
                            ${cat}
                            ${todayTasksByCategory[cat] ? '<span class="today-indicator"></span>' : ''}
                        </span>
                        <span class="filter-count">${taskCountByCategory[cat] || 0}</span>
                    </div>
                `).join('')}
            `;
        }

        function setFilter(category) {
            currentFilter = category;
            renderCategoryFilter();
            renderTasks();
        }

        // ===== ä»»åŠ¡ç®¡ç† =====
        
        function addTask() {
            const nameInput = document.getElementById('taskName');
            const dateInput = document.getElementById('startDate');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥å­¦ä¹ ä»»åŠ¡åç§°');
                return;
            }
            
            const task = {
                id: Date.now(),
                name: name,
                startTime: dateInput.value || null,
                categories: [...selectedTaskCategories],
                schedule: null,
                expanded: false
            };
            
            if (task.startTime) {
                task.schedule = generateSchedule(new Date(task.startTime));
            }
            
            tasks.unshift(task);
            
            nameInput.value = '';
            dateInput.value = '';
            selectedTaskCategories = [];
            
            renderSelectedCategories();
            renderCategoryFilter();
            renderTasks();
            
            if (cloudSyncEnabled) {
                saveDataToGitHub();
            } else {
                saveDataToLocal();
            }
        }

        function generateSchedule(startDate) {
            const intervals = [
                { minutes: 5, label: 'ç¬¬1æ¬¡å¤ä¹  (5åˆ†é’Ÿå)' },
                { minutes: 30, label: 'ç¬¬2æ¬¡å¤ä¹  (30åˆ†é’Ÿå)' },
                { hours: 12, label: 'ç¬¬3æ¬¡å¤ä¹  (12å°æ—¶å)' },
                { days: 1, label: 'ç¬¬4æ¬¡å¤ä¹  (1å¤©å)' },
                { days: 2, label: 'ç¬¬5æ¬¡å¤ä¹  (2å¤©å)' },
                { days: 4, label: 'ç¬¬6æ¬¡å¤ä¹  (4å¤©å)' },
                { days: 7, label: 'ç¬¬7æ¬¡å¤ä¹  (7å¤©å)' },
                { days: 15, label: 'ç¬¬8æ¬¡å¤ä¹  (15å¤©å)' },
                { days: 30, label: 'ç¬¬9æ¬¡å¤ä¹  (30å¤©å)' }
            ];
            
            return intervals.map(interval => {
                const reviewTime = new Date(startDate);
                
                if (interval.minutes) {
                    reviewTime.setMinutes(reviewTime.getMinutes() + interval.minutes);
                } else if (interval.hours) {
                    reviewTime.setHours(reviewTime.getHours() + interval.hours);
                } else if (interval.days) {
                    reviewTime.setDate(reviewTime.getDate() + interval.days);
                }
                
                return {
                    time: reviewTime,
                    label: interval.label,
                    checked: false
                };
            });
        }

        function updateTaskDate(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const dateInput = document.getElementById(`edit-date-${taskId}`);
            const newDate = dateInput.value;
            
            if (!newDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ');
                return;
            }
            
            task.startTime = newDate;
            task.schedule = generateSchedule(new Date(newDate));
            
            renderTasks();
            
            if (cloudSyncEnabled) {
                saveDataToGitHub();
            } else {
                saveDataToLocal();
            }
            
            alert(task.schedule ? 'å¤ä¹ è®¡åˆ’å·²æ›´æ–°ï¼' : 'å¤ä¹ è®¡åˆ’å·²ç”Ÿæˆï¼');
        }

        function updateTaskCategories(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const select = document.getElementById(`edit-cat-${taskId}`);
            const category = select.value;
            
            if (category && !task.categories.includes(category)) {
                task.categories.push(category);
                renderCategoryFilter();
                renderTasks();
                
                if (cloudSyncEnabled) {
                    saveDataToGitHub();
                } else {
                    saveDataToLocal();
                }
            }
            
            select.value = '';
        }

        function removeTaskCategory(taskId, category) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.categories = task.categories.filter(c => c !== category);
            renderCategoryFilter();
            renderTasks();
            
            if (cloudSyncEnabled) {
                saveDataToGitHub();
            } else {
                saveDataToLocal();
            }
        }

        function deleteTask(taskId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦ä¹ ä»»åŠ¡å—ï¼Ÿ')) {
                tasks = tasks.filter(t => t.id !== taskId);
                renderCategoryFilter();
                renderTasks();
                
                if (cloudSyncEnabled) {
                    saveDataToGitHub();
                } else {
                    saveDataToLocal();
                }
            }
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.expanded = !task.expanded;
                renderTasks();
            }
        }

        function toggleCheck(taskId, reviewIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.schedule) {
                task.schedule[reviewIndex].checked = !task.schedule[reviewIndex].checked;
                renderTasks();
                
                if (cloudSyncEnabled) {
                    saveDataToGitHub();
                } else {
                    saveDataToLocal();
                }
            }
        }

        // ===== è¾…åŠ©å‡½æ•° =====
        
        function formatDateTime(date, includeTime = true) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            
            if (!includeTime) {
                return `${year}-${month}-${day}`;
            }
            
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function isOverdue(date) {
            return new Date(date) < new Date();
        }

        function hasTodayReview(task) {
            if (!task.schedule) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            return task.schedule.some(review => {
                const reviewDate = new Date(review.time);
                return reviewDate >= today && reviewDate < tomorrow && !review.checked;
            });
        }

        function getFilteredTasks() {
            if (currentFilter === '') {
                return tasks;
            }
            return tasks.filter(task => task.categories.includes(currentFilter));
        }

        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            const filteredTasks = getFilteredTasks();
            
            if (filteredTasks.length === 0) {
                const message = currentFilter 
                    ? `å½“å‰åˆ†ç±»"${currentFilter}"ä¸‹æ²¡æœ‰ä»»åŠ¡`
                    : 'è¿˜æ²¡æœ‰å¤ä¹ è®¡åˆ’ï¼Œè¯·æ·»åŠ ä¸€ä¸ªå­¦ä¹ ä»»åŠ¡';
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“…</div>
                        <div class="empty-text">${message}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredTasks.map(task => {
                const hasToday = hasTodayReview(task);
                const hasSchedule = task.schedule !== null;
                
                let scheduleHtml = '';
                if (hasSchedule) {
                    scheduleHtml = task.schedule.map((review, index) => {
                        const overdue = isOverdue(review.time);
                        const itemClass = review.checked ? 'completed' : (overdue ? 'overdue' : 'pending');
                        
                        let badge = '';
                        if (review.checked) {
                            badge = '<span class="status-badge badge-done">âœ“ å·²å®Œæˆ</span>';
                        } else if (overdue) {
                            badge = '<span class="status-badge badge-overdue">å·²è¿‡æœŸ</span>';
                        } else if (index === 0) {
                            badge = '<span class="status-badge badge-current">å½“å‰</span>';
                        }

                        return `
                            <div class="review-item ${itemClass}">
                                <div class="review-header">
                                    <div class="review-label">${review.label}</div>
                                    ${badge}
                                </div>
                                <div class="review-time">${formatDateTime(review.time, false)}</div>
                                <button class="check-btn ${review.checked ? 'checked' : 'unchecked'}" 
                                        onclick="toggleCheck(${task.id}, ${index})">
                                    ${review.checked ? 'âœ“ å·²æ‰“å¡' : 'æ‰“å¡'}
                                </button>
                            </div>
                        `;
                    }).join('');
                }

                const categoriesBadges = task.categories.map(cat => 
                    `<span class="task-category-badge">${cat}</span>`
                ).join('');

                const editCategoriesTags = task.categories.map(cat => 
                    `<div class="category-tag">
                        <span>${cat}</span>
                        <span class="remove" onclick="removeTaskCategory(${task.id}, '${cat}')">Ã—</span>
                    </div>`
                ).join('');

                const categoryOptions = categories.map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');

                return `
                    <div class="task-card">
                        <div class="task-header ${!hasSchedule ? 'no-schedule' : ''}" onclick="toggleTask(${task.id})">
                            <div class="task-header-content">
                                <div class="task-title-area">
                                    <div class="task-title-row">
                                        <div class="task-name">${task.name}</div>
                                        ${hasToday ? '<span class="today-badge">ä»Šæ—¥æœ‰å¤ä¹ </span>' : ''}
                                        ${!hasSchedule ? '<span class="no-schedule-badge">æœªç”Ÿæˆè®¡åˆ’</span>' : ''}
                                    </div>
                                    <div class="task-categories">
                                        ${categoriesBadges}
                                    </div>
                                    <div class="task-time" style="margin-top: 8px;">
                                        ${task.startTime ? 'ğŸ• å¼€å§‹æ—¶é—´: ' + formatDateTime(new Date(task.startTime), false) : 'âš ï¸ æœªè®¾ç½®å¼€å§‹æ—¶é—´'}
                                    </div>
                                </div>
                                <div class="task-actions">
                                    <button class="icon-btn" onclick="event.stopPropagation(); deleteTask(${task.id})" title="åˆ é™¤ä»»åŠ¡">
                                        ğŸ—‘ï¸
                                    </button>
                                    <button class="icon-btn">
                                        ${task.expanded ? 'â–²' : 'â–¼'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="task-content ${task.expanded ? 'expanded' : ''}">
                            <div class="task-edit-section">
                                <div class="task-edit-title">ğŸ“ ç¼–è¾‘ä»»åŠ¡ä¿¡æ¯</div>
                                <div class="edit-row">
                                    <div class="input-wrapper">
                                        <label>ä¿®æ”¹å¼€å§‹æ—¥æœŸ</label>
                                        <input type="date" id="edit-date-${task.id}" value="${task.startTime || ''}">
                                    </div>
                                    <div class="input-wrapper">
                                        <label style="opacity: 0;">å ä½</label>
                                        <button class="btn btn-small" onclick="updateTaskDate(${task.id})">
                                            ${hasSchedule ? 'ğŸ”„ æ›´æ–°è®¡åˆ’' : 'âœ¨ ç”Ÿæˆè®¡åˆ’'}
                                        </button>
                                    </div>
                                </div>
                                <div class="input-wrapper">
                                    <label>ä¿®æ”¹åˆ†ç±»</label>
                                    <select id="edit-cat-${task.id}" onchange="updateTaskCategories(${task.id})">
                                        <option value="">-- æ·»åŠ åˆ†ç±» --</option>
                                        ${categoryOptions}
                                    </select>
                                    <div class="categories-list" style="margin-top: 10px;">
                                        ${editCategoriesTags}
                                    </div>
                                </div>
                                ${!hasSchedule ? `
                                    <div style="margin-top: 15px;">
                                        <button class="btn btn-small btn-delete" onclick="deleteTask(${task.id})">
                                            ğŸ—‘ï¸ åˆ é™¤æ­¤ä»»åŠ¡
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            ${hasSchedule ? `
                                <div class="schedule-grid">
                                    ${scheduleHtml}
                                </div>
                            ` : '<div style="text-align: center; padding: 20px; color: #999;">è¯·è®¾ç½®å¼€å§‹æ—¥æœŸå¹¶ç”Ÿæˆå¤ä¹ è®¡åˆ’</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===== æ•°æ®å¯¼å…¥å¯¼å‡º =====
        
        function exportData() {
            const data = {
                tasks: tasks,
                categories: categories,
                exportedAt: new Date().toISOString(),
                version: '3.0-hybrid'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¤ä¹ è®¡åˆ’å¤‡ä»½_${formatDateTime(new Date(), false).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('âœ… æ•°æ®å·²å¯¼å‡ºä¸ºæœ¬åœ°å¤‡ä»½ï¼');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (tasks.length > 0) {
                        if (!confirm('âš ï¸ å¯¼å…¥æ•°æ®ä¼šè¦†ç›–å½“å‰çš„æ‰€æœ‰ä»»åŠ¡ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                            event.target.value = '';
                            return;
                        }
                    }
                    
                    tasks = data.tasks || [];
                    categories = data.categories || ['è‹±è¯­', 'æ•°å­¦', 'ç¼–ç¨‹', 'é˜…è¯»'];
                    currentFilter = '';
                    selectedTaskCategories = [];
                    
                    renderAll();
                    
                    if (cloudSyncEnabled) {
                        saveDataToGitHub();
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${tasks.length} ä¸ªä»»åŠ¡ï¼\n\næ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ã€‚`);
                    } else {
                        saveDataToLocal();
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${tasks.length} ä¸ªä»»åŠ¡ï¼`);
                    }
                } catch (error) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å’Œåˆ†ç±»å—ï¼Ÿ')) {
                    tasks = [];
                    categories = ['è‹±è¯­', 'æ•°å­¦', 'ç¼–ç¨‹', 'é˜…è¯»'];
                    currentFilter = '';
                    selectedTaskCategories = [];
                    
                    renderAll();
                    
                    if (cloudSyncEnabled) {
                        saveDataToGitHub();
                    } else {
                        saveDataToLocal();
                    }
                    
                    alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
                }
            }
        }

        // ===== äº‹ä»¶ç›‘å¬ =====
        
        document.getElementById('categorySelect').addEventListener('change', selectCategory);
        
        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', function() {
            if (cloudSyncEnabled && isConfigured()) {
                saveDataToGitHub();
            } else {
                saveDataToLocal();
            }
        });

        // å®šæœŸè‡ªåŠ¨åŒæ­¥ï¼ˆæ¯60ç§’ï¼‰
        setInterval(function() {
            if (cloudSyncEnabled && isConfigured() && !isSyncing) {
                saveDataToGitHub();
            }
        }, 60000);
    </script>
</body>
</html>
